diff --git a/audio/out/ao_avfoundation.m b/audio/out/ao_avfoundation.m
--- a/audio/out/ao_avfoundation.m
+++ b/audio/out/ao_avfoundation.m
@@ -208,9 +208,9 @@ static void feed(struct ao *ao)
     return self;
 }
 - (void)handleRestartNotification:(NSNotification*)notification {
-    char *name = cfstr_get_cstr((CFStringRef)notification.name);
+    const char *name = [notification.name UTF8String];
     MP_WARN(ao, "restarting due to system notification; this will cause desync\n");
-    MP_VERBOSE(ao, "notification name: %s\n", name);
-    talloc_free(name);
+    MP_VERBOSE(ao, "notification name: %s\n", name ? name : "(null)");
     stop(ao);
     start(ao);
 }
@@ -249,9 +249,11 @@ static int init(struct ao *ao)
         goto error;
     }

+#if !TARGET_OS_IPHONE
     if (ao->device && ao->device[0]) {
         [p->renderer setAudioOutputDeviceUniqueID:(NSString*)cfstr_from_cstr(ao->device)];
     }
+#endif

     [p->synchronizer addRenderer:p->renderer];
 #if HAVE_MACOS_11_3_FEATURES
@@ -362,7 +364,9 @@ const struct ao_driver audio_out_avfoundation = {
     .reset          = stop,
     .start          = start,
     .set_pause      = set_pause,
+#if !TARGET_OS_IPHONE
     .list_devs      = ca_get_device_list,
+#endif
     .priv_size      = sizeof(struct priv),
 };
diff --git a/audio/out/ao_coreaudio_chmap.h b/audio/out/ao_coreaudio_chmap.h
--- a/audio/out/ao_coreaudio_chmap.h
+++ b/audio/out/ao_coreaudio_chmap.h
@@ -29,8 +29,10 @@ AudioChannelLabel mp_speaker_id_to_ca_label(int speaker_id);
 #if HAVE_COREAUDIO || HAVE_AVFOUNDATION
 AudioChannelLayout *ca_find_standard_layout(void *talloc_ctx, AudioChannelLayout *l);
 AudioChannelLayout *ca_get_acl(struct ao *ao, size_t *out_layout_size);
 void ca_log_layout(struct ao *ao, int l, AudioChannelLayout *layout);
+#if HAVE_COREAUDIO
 bool ca_init_chmap(struct ao *ao, AudioDeviceID device);
 void ca_get_active_chmap(struct ao *ao, AudioDeviceID device, int channel_count,
                          struct mp_chmap *out_map);
 #endif
+#endif
diff --git a/audio/out/ao_coreaudio_chmap.c b/audio/out/ao_coreaudio_chmap.c
--- a/audio/out/ao_coreaudio_chmap.c
+++ b/audio/out/ao_coreaudio_chmap.c
@@ -405,6 +405,7 @@ coreaudio_error:
     return false;
 }

+#if HAVE_COREAUDIO
 static AudioChannelLayout* ca_query_layout(struct ao *ao,
                                            AudioDeviceID device,
                                            void *talloc_ctx)
@@ -532,4 +533,5 @@ void ca_get_active_chmap(struct ao *ao, AudioDeviceID device, int channel_count,
     MP_WARN(ao, "mismatching channels - falling back to %s\n",
             mp_chmap_to_str(out_map));
 }
+#endif /* HAVE_COREAUDIO */
 #endif
diff --git a/audio/out/ao_coreaudio_utils.c b/audio/out/ao_coreaudio_utils.c
--- a/audio/out/ao_coreaudio_utils.c
+++ b/audio/out/ao_coreaudio_utils.c
@@ -28,7 +28,7 @@
 #include "audio/format.h"
 #include "osdep/mac/compat.h"

-#if HAVE_COREAUDIO || HAVE_AVFOUNDATION
+#if HAVE_COREAUDIO
 #include "audio/out/ao_coreaudio_properties.h"
 #include <CoreAudio/HostTime.h>
 #else
@@ -36,7 +36,7 @@
 #endif

-#if HAVE_COREAUDIO || HAVE_AVFOUNDATION
+#if HAVE_COREAUDIO
 static bool ca_is_output_device(struct ao *ao, AudioDeviceID dev)
 {
     size_t n_buffers;
@@ -300,7 +300,7 @@ int64_t ca_frames_to_ns(struct ao *ao, uint32_t frames)
 int64_t ca_get_latency(const AudioTimeStamp *ts)
 {
-#if HAVE_COREAUDIO || HAVE_AVFOUNDATION
+#if HAVE_COREAUDIO
     uint64_t out = AudioConvertHostTimeToNanos(ts->mHostTime);
     uint64_t now = AudioConvertHostTimeToNanos(AudioGetCurrentHostTime());

@@ -323,7 +323,7 @@ int64_t ca_get_latency(const AudioTimeStamp *ts)
 #endif
 }

-#if HAVE_COREAUDIO || HAVE_AVFOUNDATION
+#if HAVE_COREAUDIO
 bool ca_stream_supports_compressed(struct ao *ao, AudioStreamID stream)
 {
     AudioStreamRangedDescription *formats = NULL;
diff --git a/audio/out/ao_coreaudio_properties.h b/audio/out/ao_coreaudio_properties.h
--- a/audio/out/ao_coreaudio_properties.h
+++ b/audio/out/ao_coreaudio_properties.h
@@ -19,6 +19,9 @@
 #ifndef MPV_COREAUDIO_PROPERTIES_H
 #define MPV_COREAUDIO_PROPERTIES_H

+#include "config.h"
+
+#if HAVE_COREAUDIO
 #include <AudioToolbox/AudioToolbox.h>

 #include "internal.h"
@@ -57,4 +60,6 @@ Boolean ca_settable(AudioObjectID id, ca_scope scope, ca_sel selector,

 #define CA_SETTABLE(id, sel, data) ca_settable(id, CA_GLOBAL, sel, data)

+#endif /* HAVE_COREAUDIO */
+
 #endif /* MPV_COREAUDIO_PROPERTIES_H */
diff --git a/audio/out/ao_coreaudio_properties.c b/audio/out/ao_coreaudio_properties.c
--- a/audio/out/ao_coreaudio_properties.c
+++ b/audio/out/ao_coreaudio_properties.c
@@ -20,6 +20,10 @@
  * Abstractions on the CoreAudio API to make property setting/getting suck less
 */

+#include "config.h"
+
+#if HAVE_COREAUDIO
+
 #include "audio/out/ao_coreaudio_properties.h"
 #include "audio/out/ao_coreaudio_utils.h"
 #include "mpv_talloc.h"
@@ -103,3 +107,5 @@ Boolean ca_settable(AudioObjectID id, ca_scope scope, ca_sel selector,

     return AudioObjectIsPropertySettable(id, &p_addr, data);
 }
+
+#endif /* HAVE_COREAUDIO */
